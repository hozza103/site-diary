<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Site Diary + Task Tree</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-database.js"></script>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --bg-color: #FFFFFF;
            --surface-color: #F4F6F8;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --border-color: #D1D5DB;

            --accent-color: #FFD700;
            --danger-color: #E53935;
            --success-color: #2E7D32;
            --info-color: #0288D1;
            --warning-color: #F57C00;
            
            --meeting-color: #8E24AA;
            --personal-color: #D81B60;
            --qa-color: #00897B;

            --p-high: #E53935;
            --p-med: #FFB300;
            --p-low: #1E88E5;

            --border-radius: 8px;
            --spacing-unit: 16px;
            --touch-target: 44px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0; padding: 0; padding-bottom: 100px;
            font-size: 16px; line-height: 1.5;
        }

        /* --- HEADER & NAV --- */
        header {
            background-color: #FFFFFF;
            padding: 12px var(--spacing-unit);
            position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .header-center { text-align: center; flex-grow: 1; }
        .date-display { font-weight: bold; font-size: 16px; color: var(--text-primary); }
        .date-status { font-size: 11px; color: #666; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;}

        .nav-btn {
            background: #F4F6F8; border: 1px solid var(--border-color);
            color: var(--text-primary); font-size: 20px;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; cursor: pointer; user-select: none;
        }
        .nav-btn:active { background: #E0E0E0; }
        
        .view-toggle-btn {
            background: #F4F6F8; color: var(--text-primary);
            border: 1px solid var(--border-color); padding: 6px 12px;
            border-radius: 4px; font-size: 12px; font-weight: bold;
            margin-left: 8px; cursor: pointer;
        }
        .qa-toggle-btn { background: var(--qa-color); color: white; border: none; }

        /* --- LAYOUT & CARDS --- */
        .container { padding: var(--spacing-unit); max-width: 600px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        .card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-left-width: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
        }

        /* --- CALENDAR GRID --- */
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 4px; margin-bottom: 20px;
        }
        .cal-header { text-align: center; font-size: 12px; color: var(--text-secondary); padding: 4px; font-weight: bold; }
        .cal-cell {
            background-color: var(--surface-color); aspect-ratio: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 4px; font-size: 14px; position: relative;
            cursor: pointer; border: 1px solid var(--border-color); color: var(--text-primary);
        }
        .cal-cell.today { border: 2px solid var(--info-color); color: var(--info-color); font-weight: bold; }
        .cal-cell.selected { background-color: #E3F2FD; border-color: var(--info-color); }
        
        .cal-indicators {
            display: flex; gap: 2px; justify-content: center; align-items: flex-end;
            position: absolute; bottom: 3px; left: 0; width: 100%; pointer-events: none;
        }
        .indicator { border-radius: 50%; width: 6px; height: 6px; }
        .indicator.multi { width: 14px; height: 14px; font-size: 9px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; line-height: 1; }
        .indicator.task { background-color: var(--info-color); }
        .indicator.task.overdue { background-color: var(--danger-color); }
        .indicator.meeting { background-color: var(--meeting-color); }
        .indicator.personal { background-color: var(--personal-color); }

        /* --- FORMS & INPUTS --- */
        input, textarea, select {
            width: 100%; background-color: #FFFFFF; color: var(--text-primary);
            border: 1px solid var(--border-color); border-radius: 4px;
            padding: 10px; font-size: 16px; min-height: var(--touch-target);
            margin-bottom: 12px;
        }
        
        /* --- TASK ITEMS --- */
        .task-item { display: flex; flex-direction: column; gap: 12px; }
        .task-item.carried-over { border-left-color: var(--danger-color); background-color: #FFF5F5; }
        .task-item.recurring { border-left-color: var(--info-color); }
        .task-item.status-Follow-Up { border-left-color: var(--warning-color); background-color: #FFF8E1; }
        .task-item.status-Completed { border-left-color: var(--success-color); background-color: #F1F8E9; opacity: 0.8; }
        .task-item.type-meeting { border-left-color: var(--meeting-color); }
        .task-item.type-personal { border-left-color: var(--personal-color); }

        .task-top-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-badges { display: flex; gap: 6px; font-size: 11px; flex-wrap: wrap; align-items: center; }
        .badge { background: #E0E0E0; padding: 3px 6px; border-radius: 3px; color: #333; font-weight: 700; }
        .badge.p-high { background: var(--p-high); color: #fff; }
        .badge.meeting { background: var(--meeting-color); color: #fff; }
        .badge.personal { background: var(--personal-color); color: #fff; }

        .task-actions { display: flex; gap: 4px; }
        .action-icon {
            background: #FFFFFF; border: 1px solid var(--border-color);
            color: var(--text-secondary); font-size: 16px; cursor: pointer;
            padding: 6px; border-radius: 4px; display: flex;
            align-items: center; justify-content: center;
        }

        .checklist-item { display: flex; align-items: flex-start; gap: 10px; padding: 6px 0; font-size: 14px; border-bottom: 1px dashed #eee; cursor: pointer; }
        .checklist-checkbox { width: 18px; height: 18px; border: 2px solid #666; border-radius: 4px; flex-shrink: 0; margin-top: 2px; position: relative; }
        .checklist-item.status-done .checklist-checkbox { background: var(--success-color); border-color: var(--success-color); }
        .checklist-item.status-done .checklist-checkbox::after { content: '‚úì'; color: white; position: absolute; top: -2px; left: 2px; font-size: 14px; font-weight: bold; }
        .checklist-item.status-followup .checklist-checkbox { background: var(--warning-color); border-color: var(--warning-color); }
        .checklist-item.status-followup .checklist-checkbox::after { content: '!'; color: white; position: absolute; top: -3px; left: 5px; font-size: 14px; font-weight: bold; }
        .checklist-item.status-followup .checklist-text { color: var(--warning-color); font-weight: 600; }
        
        .progress-bar-bg { background: #E0E0E0; height: 6px; border-radius: 3px; margin-bottom: 8px; overflow: hidden; }
        .progress-bar-fill { background: var(--success-color); height: 100%; transition: width 0.3s ease; }
        
        .status-btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 4px; }
        .status-btn { background: #FFF; border: 1px solid #D1D5DB; padding: 8px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .status-btn.active-completed { background: var(--success-color); color: white; border-color: var(--success-color); }

        /* --- FOOTER & MODALS --- */
        .thumb-zone {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(255,255,255,1) 80%, rgba(255,255,255,0));
            padding: 20px; display: flex; justify-content: center; z-index: 200;
        }
        .btn-primary {
            background-color: #333; color: #FFF; border: none; border-radius: 50px;
            padding: 14px 32px; font-size: 16px; font-weight: 800;
            text-transform: uppercase; width: 100%; max-width: 400px;
            cursor: pointer; min-height: 50px; box-shadow: 0 4px 12px rgba(0,0,0, 0.2);
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; justify-content: center; align-items: flex-end;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: #FFFFFF; width: 100%; max-width: 600px;
            padding: 24px; border-radius: 16px 16px 0 0;
            max-height: 90vh; overflow-y: auto;
        }
        .type-selector { display: flex; gap: 8px; margin-bottom: 20px; background: #F5F5F5; padding: 4px; border-radius: 8px; }
        .type-btn { flex: 1; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .type-btn.active { background: #FFF; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .btn-group { display: flex; gap: 16px; margin-top: 16px; }
        .btn-save { background: #333; color: white; border: none; flex: 1; padding: 16px; border-radius: 8px; font-weight: bold; }
        .btn-cancel { background: #F5F5F5; color: #333; border: 1px solid #DDD; flex: 1; padding: 16px; border-radius: 8px; font-weight: bold; }
        
        /* QA Styles */
        .qa-card { border-left: 5px solid var(--qa-color); padding: 16px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 8px; }
        .qa-question { font-weight: bold; margin-bottom: 8px; }
        .qa-answer-box { background: #FAFAFA; padding: 10px; border-radius: 4px; margin-top: 8px; font-size: 14px; }
        .qa-meta { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-bottom: 8px; }
    </style>
</head>
<body>

    <header>
        <button class="nav-btn" id="nav-prev" onclick="navDate(-1)">&#10094;</button>
        <div class="header-center">
            <div class="date-status" id="date-status">TODAY</div>
            <div class="date-display" id="date-display">Loading...</div>
        </div>
        <div style="display:flex;">
            <button class="view-toggle-btn" onclick="toggleView()" id="view-toggle-text">CALENDAR</button>
            <button class="view-toggle-btn qa-toggle-btn" onclick="toggleQA()" id="qa-toggle-text">Q&A</button>
        </div>
        <button class="nav-btn" id="nav-next" onclick="navDate(1)">&#10095;</button>
    </header>

    <div class="container">
        <div id="calendar-view" class="hidden">
            <div class="calendar-grid">
                <div class="cal-header">Sun</div><div class="cal-header">Mon</div><div class="cal-header">Tue</div>
                <div class="cal-header">Wed</div><div class="cal-header">Thu</div><div class="cal-header">Fri</div>
                <div class="cal-header">Sat</div>
                <div id="calendar-cells" style="display: contents;"></div>
            </div>
            <p style="text-align: center; color: #888;">Select a date to view entries</p>
        </div>

        <div id="day-view">
            <h2 style="margin-left: 4px; margin-top: 16px; display: flex; justify-content: space-between; align-items: center; color: #666;">
                Entries
                <span id="task-count" style="font-size: 12px; background: #EEE; padding: 4px 8px; border-radius: 12px; color: #666; border: 1px solid #ddd;">0/0</span>
            </h2>
            <div id="task-list"></div>
        </div>

        <div id="qa-view" class="hidden">
            <div style="text-align:center; padding: 10px; background: #E0F2F1; border-radius: 8px; border: 1px solid #B2DFDB; margin-bottom: 20px;">
                <span style="color: #00695C; font-size: 12px; font-weight: bold; text-transform: uppercase;">Questions Asked Today</span><br>
                <span id="qa-today-count" style="font-size: 24px; font-weight: bold; color: #004D40;">0</span>
            </div>
            <div class="qa-input-area" style="background:#fff; padding:16px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px;">
                <textarea id="qa-input-text" placeholder="What do you need to ask?" style="min-height: 60px;"></textarea>
                <button onclick="addQuestion()" style="background: var(--qa-color); color: white; width: 100%; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top:8px;">SAVE QUESTION</button>
            </div>
            <div id="qa-list-pending"></div>
            <h2 style="color: #666; margin-top: 30px;">Answered</h2>
            <div id="qa-list-answered"></div>
        </div>
    </div>

    <footer class="thumb-zone" id="main-footer">
        <button class="btn-primary" onclick="openModal()">+ Add Entry</button>
    </footer>

    <div class="modal-overlay" id="add-task-modal">
        <div class="modal-content">
            <div style="text-align:center; margin-bottom:12px; color:#666;">
                <span id="modal-title">New Entry</span> for: <span id="modal-date-display" style="font-weight:bold; color:#333;"></span>
            </div>
            <input type="hidden" id="entry-id">
            <div class="type-selector">
                <button class="type-btn active" data-type="task" onclick="setEntryType('task')">WORK TASK</button>
                <button class="type-btn" data-type="meeting" onclick="setEntryType('meeting')">MEETING</button>
                <button class="type-btn" data-type="personal" onclick="setEntryType('personal')">PERSONAL</button>
            </div>
            <label id="desc-label">Description</label>
            <textarea id="new-task-desc" placeholder="What needs to be done?"></textarea>
            
            <div id="field-checklist">
                <label>Checklist (Optional)</label>
                <textarea id="new-task-checklist" placeholder="One item per line" style="min-height: 80px;"></textarea>
            </div>
            
            <div id="field-time" class="hidden">
                <div style="display: flex; gap: 12px;">
                    <div style="flex:1"><label>Start</label><input type="time" id="new-task-start"></div>
                    <div style="flex:1"><label>End</label><input type="time" id="new-task-end"></div>
                </div>
            </div>
            
            <div id="field-priority">
                <label>Priority</label>
                <select id="new-task-priority">
                    <option value="High">High</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            
            <div id="field-location">
                <label>Location</label>
                <select id="new-task-loc">
                    <option value="Site Wide">Site Wide</option>
                    <option value="Basement">Basement</option>
                    <option value="Ground Floor">Ground Floor</option>
                    <option value="Level 1">Level 1</option>
                    <option value="Level 2">Level 2</option>
                    <option value="Roof">Roof</option>
                    <option value="Exterior">Exterior</option>
                    <option value="Off Site">Off Site</option>
                </select>
            </div>
            
            <label>Recurrence</label>
            <select id="new-task-recurrence">
                <option value="none">None (One-off)</option>
                <option value="daily">Daily (Next 14 Days)</option>
                <option value="daily_indef">Daily (Indefinite)</option>
                <option value="weekly">Weekly (Next 8 Weeks)</option>
                <option value="weekly_indef">Weekly (Indefinite)</option>
            </select>

            <div class="btn-group">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-save" onclick="saveEntry()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="answer-modal">
        <div class="modal-content">
            <h3>Record Response</h3>
            <p id="answer-modal-q-text" style="font-weight: bold; margin-bottom: 16px;"></p>
            <input type="hidden" id="answer-id">
            <textarea id="answer-input" placeholder="Answer here..." style="min-height: 120px;"></textarea>
            <div class="btn-group">
                <button class="btn-cancel" onclick="closeAnswerModal()">Cancel</button>
                <button class="btn-save" onclick="saveAnswer()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="delete-modal">
        <div class="modal-content" style="text-align: center;">
            <h3 style="color: var(--danger-color);">Delete Entry?</h3>
            <p id="delete-msg">This action cannot be undone.</p>
            <div class="btn-group" id="delete-btn-group">
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn-save" style="background-color: var(--danger-color);" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES (Initialize first) ---
        let appData = {};
        let rulesData = [];
        let qaData = [];
        let actualTodayKey = "";
        let currentViewDateKey = "";
        let currentCalendarMonth = new Date();
        let isCalendarMode = false;
        let isQAMode = false;
        let currentEntryType = "task";
        let taskToDeleteId = null;
        let db = null;
        let isAuthenticated = false;
        let dbListener = null;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBt4C1e7tl6r3kaMTquH2RfXR6pKmj4fv8",
            appId: "1:829300004668:web:be01e15a18d2a7022d3039",
            authDomain: "site-diary-35e48.firebaseapp.com",
            projectId: "site-diary-35e48",
            storageBucket: "site-diary-35e48.appspot.com",
            messagingSenderId: "367375252874",
            databaseURL: "https://site-diary-35e48-default-rtdb.firebaseio.com/",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();

        // --- AUTHENTICATION (CRITICAL FOR SECURITY) ---
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                // User is signed in (anonymously)
                console.log('‚úÖ Authenticated with user ID:', user.uid);
                isAuthenticated = true;
                
                // Only initialize app after authentication
                if (!actualTodayKey) {
                    initApp();
                }
            } else {
                // No user signed in, sign in anonymously
                console.log('üîê Signing in anonymously...');
                document.getElementById('date-display').textContent = "Authenticating...";
                
                firebase.auth().signInAnonymously()
                    .catch((error) => {
                        console.error('‚ùå Authentication error:', error);
                        document.getElementById('date-display').textContent = "Auth Failed";
                        alert('Failed to authenticate. Please refresh the page.');
                    });
            }
        });

        // --- UTILS ---
        function getFormattedDate(d) { return d.toISOString().split('T')[0]; }
        function getDisplayDate(str) { return new Date(str+"T00:00:00").toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' }); }
        function getMonthTitle(d) { return d.toLocaleDateString('en-US', { month:'long', year:'numeric' }); }

        function initApp() {
            // Only initialize if we haven't already and if authenticated
            if (actualTodayKey || !isAuthenticated) return;
            
            console.log('üöÄ Initializing app...');
            
            const d = new Date();
            actualTodayKey = getFormattedDate(d);
            currentViewDateKey = actualTodayKey;
            document.getElementById('date-display').textContent = "Loading...";

            // Check Migration
            const localRaw = localStorage.getItem('SITE_DIARY_DATA');
            if (localRaw && !localStorage.getItem('FIREBASE_MIGRATED')) {
                if(confirm("Upload old local data to Cloud?")) {
                    db.ref('siteDiary').update({
                        entries: JSON.parse(localRaw),
                        rules: JSON.parse(localStorage.getItem('SITE_DIARY_RULES')||"[]"),
                        qa: JSON.parse(localStorage.getItem('SITE_DIARY_QA')||"[]")
                    }).then(() => {
                        localStorage.setItem('FIREBASE_MIGRATED','true');
                        console.log('‚úÖ Migration complete');
                    }).catch(err => {
                        console.error('‚ùå Migration failed:', err);
                    });
                }
            }

            // Listen to DB (only set up once)
            if (!dbListener) {
                dbListener = db.ref('siteDiary').on('value', (snapshot) => {
            // Listen to DB (only set up once)
            if (!dbListener) {
                dbListener = db.ref('siteDiary').on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    appData = data.entries || {};
                    rulesData = data.rules || [];
                    qaData = data.qa || [];

                    // --- CRITICAL FIX FOR CRASHES ---
                    // Filter out nulls and fix broken arrays
                    Object.keys(appData).forEach(key => {
                        if(!appData[key].tasks) appData[key].tasks = [];
                        else if(!Array.isArray(appData[key].tasks)) appData[key].tasks = Object.values(appData[key].tasks);
                        
                        // REMOVE NULLS (The main fix)
                        appData[key].tasks = appData[key].tasks.filter(t => t !== null && t !== undefined);
                    });

                    if(!appData[actualTodayKey]) initDayEntry(actualTodayKey);

                    processRecurringRules();
                    runRollingWave();
                    
                    if(isCalendarMode) renderCalendar();
                    else if(isQAMode) renderQAView();
                    else renderDayView();
                    
                    console.log('‚úÖ Data synced');
                }, (error) => {
                    console.error('‚ùå Database error:', error);
                    document.getElementById('date-display').textContent = "Sync Error";
                });
            }
        }

        function initDayEntry(key) {
            if(!appData[key]) appData[key] = { tasks: [], hasRolledOver: false };
            if(!appData[key].tasks) appData[key].tasks = [];
        }

        function saveData() { db.ref('siteDiary/entries').set(appData); }
        function saveRules() { db.ref('siteDiary/rules').set(rulesData); }
        function saveQA() { db.ref('siteDiary/qa').set(qaData); renderQAView(); }

        // --- RECURRENCE ---
        function processRecurringRules() {
            if(!rulesData.length) return;
            const start = new Date(actualTodayKey+"T00:00:00");
            let dirty = false;
            rulesData.forEach(rule => {
                for(let i=0; i<=90; i++) {
                    let d = new Date(start); d.setDate(d.getDate()+i);
                    let diff = Math.floor((d - new Date(rule.createdDate+"T00:00:00"))/(86400000));
                    if(diff < 0) continue;
                    let match = (rule.frequency === 'daily_indef') || (rule.frequency === 'weekly_indef' && diff%7===0);
                    if(match) {
                        const key = getFormattedDate(d);
                        initDayEntry(key);
                        if(!appData[key].tasks.some(t => t.rule_id === rule.id)) {
                            appData[key].tasks.push({
                                id: "t_"+Math.random().toString(36).substr(2,9),
                                rule_id: rule.id, type: rule.type, description: `[RECURRING] ${rule.description}`,
                                status: "Pending", priority: rule.priority, checklist: rule.checklist?JSON.parse(JSON.stringify(rule.checklist)):[],
                                is_recurring: true
                            });
                            dirty = true;
                        }
                    }
                }
            });
            if(dirty) saveData();
        }

        function runRollingWave() {
            const yest = new Date(actualTodayKey+"T00:00:00");
            yest.setDate(yest.getDate()-1);
            const yKey = getFormattedDate(yest);
            
            initDayEntry(actualTodayKey);
            if(appData[yKey] && !appData[actualTodayKey].hasRolledOver) {
                const toRoll = appData[yKey].tasks.filter(t => (t.status==='Pending'||t.status==='Follow Up') && !t.is_recurring && t.type!=='meeting');
                if(toRoll.length) {
                    const moved = toRoll.map(t => ({...t, id:"t_"+Date.now()+Math.random(), description: `[CARRIED OVER] ${t.description.replace('[CARRIED OVER] ','')}`, is_carried_over:true }));
                    appData[actualTodayKey].tasks.push(...moved);
                }
                appData[actualTodayKey].hasRolledOver = true;
                saveData();
            }
        }

        // --- VIEWS ---
        function toggleView() {
            if(isQAMode) toggleQA(); // Exit QA first
            isCalendarMode = !isCalendarMode;
            document.getElementById('day-view').classList.toggle('hidden', isCalendarMode);
            document.getElementById('calendar-view').classList.toggle('hidden', !isCalendarMode);
            document.getElementById('view-toggle-text').textContent = isCalendarMode ? "LIST" : "CALENDAR";
            document.getElementById('date-status').textContent = isCalendarMode ? "MONTH VIEW" : (currentViewDateKey===actualTodayKey?"TODAY":"LOG");
            
            // Show/hide navigation arrows based on mode
            document.getElementById('nav-prev').classList.remove('hidden');
            if(isCalendarMode) {
                document.getElementById('nav-next').classList.remove('hidden');
            } else {
                document.getElementById('nav-next').classList.toggle('hidden', currentViewDateKey===actualTodayKey);
            }
            
            if(isCalendarMode) {
                currentCalendarMonth = new Date(currentViewDateKey+"T00:00:00");
                renderCalendar();
            } else renderDayView();
        }

        function toggleQA() {
            isQAMode = !isQAMode;
            isCalendarMode = false;
            document.getElementById('qa-view').classList.toggle('hidden', !isQAMode);
            document.getElementById('day-view').classList.toggle('hidden', isQAMode);
            document.getElementById('calendar-view').classList.add('hidden');
            document.getElementById('main-footer').classList.toggle('hidden', isQAMode);
            document.getElementById('nav-prev').classList.toggle('hidden', isQAMode);
            document.getElementById('nav-next').classList.toggle('hidden', isQAMode);
            
            document.getElementById('qa-toggle-text').textContent = isQAMode ? "CLOSE QA" : "Q&A";
            document.getElementById('view-toggle-text').textContent = "CALENDAR";
            
            if(isQAMode) {
                document.getElementById('date-display').textContent = "Log & Responses";
                document.getElementById('date-status').textContent = "QUESTIONS";
                renderQAView();
            } else {
                renderDayView();
            }
        }

        function navDate(dir) {
            if(isCalendarMode) {
                currentCalendarMonth.setMonth(currentCalendarMonth.getMonth()+dir);
                renderCalendar();
            } else {
                const d = new Date(currentViewDateKey+"T00:00:00");
                d.setDate(d.getDate()+dir);
                currentViewDateKey = getFormattedDate(d);
                renderDayView();
            }
        }
        
        function jumpToDate(key) {
            currentViewDateKey = key;
            if(isCalendarMode) toggleView();
            else renderDayView();
        }

        // --- RENDERERS ---
        function renderCalendar() {
            document.getElementById('date-display').textContent = getMonthTitle(currentCalendarMonth);
            const grid = document.getElementById('calendar-cells'); grid.innerHTML = "";
            const y = currentCalendarMonth.getFullYear(), m = currentCalendarMonth.getMonth();
            const first = new Date(y, m, 1).getDay();
            const total = new Date(y, m+1, 0).getDate();

            for(let i=0; i<first; i++) grid.innerHTML += `<div class="cal-cell" style="opacity:0; pointer-events:none;"></div>`;
            
            for(let d=1; d<=total; d++) {
                const key = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const entry = appData[key];
                let cls = "cal-cell";
                if(key===actualTodayKey) cls += " today";
                if(key===currentViewDateKey) cls += " selected";
                
                let badges = "";
                if(entry && entry.tasks && entry.tasks.length) {
                    // Safe filter
                    const tasks = entry.tasks.filter(t => t);
                    let counts = { task:0, meeting:0, personal:0, overdue:false };
                    tasks.forEach(t => {
                        counts[t.type||'task']++;
                        if((t.status==='Pending'||t.status==='Follow Up') && key<actualTodayKey && t.type!=='meeting') counts.overdue=true;
                    });
                    
                    const dot = (c, type, alert) => c>0 ? `<div class="indicator ${type} ${alert?'overdue':''} ${c>1?'multi':''}">${c>1?c:''}</div>` : '';
                    badges = `<div class="cal-indicators">
                        ${dot(counts.task, 'task', counts.overdue)}
                        ${dot(counts.meeting, 'meeting')}
                        ${dot(counts.personal, 'personal')}
                    </div>`;
                }
                grid.innerHTML += `<div class="${cls}" onclick="jumpToDate('${key}')">${d}${badges}</div>`;
            }
        }

        function renderDayView() {
            initDayEntry(currentViewDateKey);
            const entry = appData[currentViewDateKey];
            document.getElementById('date-display').textContent = getDisplayDate(currentViewDateKey);
            const statusLabel = document.getElementById('date-status');
            
            if(currentViewDateKey === actualTodayKey) { statusLabel.textContent="TODAY"; statusLabel.style.color="var(--success-color)"; document.getElementById('nav-next').classList.add('hidden'); }
            else if(currentViewDateKey < actualTodayKey) { statusLabel.textContent="PAST LOG"; statusLabel.style.color="#888"; document.getElementById('nav-next').classList.remove('hidden'); }
            else { statusLabel.textContent="LOOKAHEAD"; statusLabel.style.color="var(--info-color)"; document.getElementById('nav-next').classList.remove('hidden'); }

            const list = document.getElementById('task-list'); list.innerHTML = "";
            const safeTasks = (entry.tasks || []).filter(t => t); // Filter Nulls
            
            document.getElementById('task-count').textContent = `${safeTasks.filter(t=>t.status==='Completed').length}/${safeTasks.length} Done`;

            if(!safeTasks.length) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:#999; font-style:italic;">No entries.<br>Tap "+ Add Entry"</div>`;
                return;
            }

            safeTasks.forEach(t => {
                const type = t.type || 'task';
                let badges = `<span class="badge ${type==='meeting'?'meeting':(type==='personal'?'personal':(t.priority==='High'?'p-high':''))}">${type==='task'?(t.priority||'Medium').toUpperCase():(type==='personal'?'PRIVATE':'MEETING')}</span>`;
                if(t.location) badges += `<span class="badge" style="background:#FFF; border:1px solid #ddd;">${t.location}</span>`;
                if(t.is_carried_over) badges += `<span class="badge carried">ROLLED OVER</span>`;
                if(t.is_recurring) badges += `<span class="badge recurring">RECURRING</span>`;
                if(t.startTime) badges += `<span class="badge" style="background:#FFF; border:1px solid #ddd;">${t.startTime}</span>`;

                let clHtml = "";
                if(t.checklist && t.checklist.length) {
                    const done = t.checklist.filter(i=>i.status==='done'||i.done).length;
                    const pct = Math.round((done/t.checklist.length)*100);
                    let items = t.checklist.map((i,idx) => {
                        const status = i.status || (i.done ? 'done' : 'pending');
                        return `
                        <div class="checklist-item status-${status}" onclick="toggleSubtask('${t.id}',${idx})">
                            <div class="checklist-checkbox"></div>
                            <div class="checklist-text">${i.text}</div>
                        </div>`;
                    }).join('');
                    clHtml = `<div class="checklist-container">
                        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
                        ${items}
                    </div>`;
                }

                list.innerHTML += `
                    <div class="card task-item type-${type} status-${(t.status||'Pending').replace(' ','-')} ${t.is_carried_over?'carried-over':''} ${t.is_recurring?'recurring':''}">
                        <div class="task-top-row">
                            <div class="task-badges">${badges}</div>
                            <div class="task-actions">
                                <button class="action-icon" onclick="editTask('${t.id}')">‚úèÔ∏è</button>
                                <button class="action-icon delete" onclick="deleteTaskPrompt('${t.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="task-desc">${t.description}</div>
                        ${clHtml}
                        <div class="status-btn-group">
                            <button class="status-btn ${t.status==='Pending'?'active-pending':''}" onclick="setStatus('${t.id}','Pending')">Pending</button>
                            <button class="status-btn ${t.status==='Follow Up'?'active-followup':''}" onclick="setStatus('${t.id}','Follow Up')">Follow Up</button>
                            <button class="status-btn ${t.status==='Completed'?'active-completed':''}" onclick="setStatus('${t.id}','Completed')">Done</button>
                        </div>
                    </div>`;
            });
        }

        // --- ACTIONS ---
        function setStatus(id, stat) {
            const t = appData[currentViewDateKey].tasks.find(x => x.id === id);
            if(t) { t.status = stat; saveData(); }
        }
        
        function toggleSubtask(id, idx) {
            const t = appData[currentViewDateKey].tasks.find(x => x.id === id);
            if(t && t.checklist[idx]) {
                let i = t.checklist[idx];
                i.status = (!i.status || i.status==='pending') ? 'done' : (i.status==='done'?'followup':'pending');
                i.done = (i.status==='done');
                saveData();
                renderDayView();
            }
        }

        function saveEntry() {
            const desc = document.getElementById('new-task-desc').value.trim();
            if(!desc) return alert("Description required");
            
            const id = document.getElementById('entry-id').value;
            const type = currentEntryType;
            const clRaw = document.getElementById('new-task-checklist').value.trim();
            const cl = clRaw ? clRaw.split('\n').filter(x=>x.trim()).map(x=>({text:x.trim(), status:'pending'})) : [];
            
            const common = {
                description: desc, type: type, location: document.getElementById('new-task-loc').value,
                priority: document.getElementById('new-task-priority').value,
                startTime: document.getElementById('new-task-start').value,
                endTime: document.getElementById('new-task-end').value,
                checklist: cl
            };

            if(id) { // Edit
                const task = appData[currentViewDateKey].tasks.find(x=>x.id===id);
                if(task) Object.assign(task, common);
                saveData();
            } else { // New
                const recur = document.getElementById('new-task-recurrence').value;
                if(recur.includes('indef')) {
                    rulesData.push({ id:"r_"+Date.now(), createdDate:currentViewDateKey, frequency:recur, ...common });
                    saveRules(); processRecurringRules();
                    alert("Recurring rule set.");
                } else {
                    let dates = [currentViewDateKey];
                    if(recur==='daily') for(let i=1;i<14;i++) { let d=new Date(currentViewDateKey+"T00:00:00"); d.setDate(d.getDate()+i); dates.push(getFormattedDate(d)); }
                    if(recur==='weekly') for(let i=1;i<9;i++) { let d=new Date(currentViewDateKey+"T00:00:00"); d.setDate(d.getDate()+(i*7)); dates.push(getFormattedDate(d)); }
                    
                    const sid = Date.now();
                    dates.forEach(k => {
                        initDayEntry(k);
                        appData[k].tasks.push({ id:"t_"+Math.random().toString(36).substr(2,9), series_id: sid, is_recurring: recur!=='none', status:'Pending', ...common });
                    });
                    saveData();
                }
            }
            closeModal();
        }

        // --- MODAL HELPERS ---
        function openModal() {
            document.getElementById('modal-date-display').textContent = getDisplayDate(currentViewDateKey);
            document.getElementById('add-task-modal').classList.add('open');
            document.getElementById('entry-id').value = "";
            document.getElementById('new-task-desc').value = "";
            document.getElementById('new-task-checklist').value = "";
            setEntryType('task');
        }
        function closeModal() { document.getElementById('add-task-modal').classList.remove('open'); }
        function setEntryType(t) {
            currentEntryType = t;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.type-btn[data-type="${t}"]`).classList.add('active');
            document.getElementById('field-time').classList.toggle('hidden', t!=='meeting');
            document.getElementById('field-checklist').classList.toggle('hidden', t==='meeting'||t==='personal');
            document.getElementById('field-priority').classList.toggle('hidden', t!=='task');
        }
        function editTask(id) {
            const t = appData[currentViewDateKey].tasks.find(x => x.id === id);
            if(!t) return;
            openModal();
            document.getElementById('entry-id').value = id;
            document.getElementById('new-task-desc').value = t.description.replace('[RECURRING] ','').replace('[CARRIED OVER] ','');
            document.getElementById('new-task-loc').value = t.location;
            if(t.checklist) document.getElementById('new-task-checklist').value = t.checklist.map(i=>i.text).join('\n');
            setEntryType(t.type||'task');
        }
        function deleteTaskPrompt(id) { taskToDeleteId=id; document.getElementById('delete-modal').classList.add('open'); }
        function closeDeleteModal() { document.getElementById('delete-modal').classList.remove('open'); }
        function confirmDelete() {
            const idx = appData[currentViewDateKey].tasks.findIndex(x => x.id === taskToDeleteId);
            if(idx>-1) { appData[currentViewDateKey].tasks.splice(idx,1); saveData(); }
            closeDeleteModal();
        }

        // --- Q&A ---
        function addQuestion() {
            const txt = document.getElementById('qa-input-text').value.trim();
            if(txt) { qaData.unshift({id:"q_"+Date.now(), text:txt, dateAsked:actualTodayKey}); saveQA(); document.getElementById('qa-input-text').value=""; }
        }
        function renderQAView() {
            const p = document.getElementById('qa-list-pending'), a = document.getElementById('qa-list-answered');
            p.innerHTML=a.innerHTML="";
            document.getElementById('qa-today-count').textContent = qaData.filter(q=>q.dateAsked===actualTodayKey).length;
            if(!qaData.length) p.innerHTML = "<div style='text-align:center; color:#999;'>No questions.</div>";
            qaData.forEach(q => {
                let h = `<div class="qa-card"><div class="qa-meta"><span>${getDisplayDate(q.dateAsked)}</span><div><span style="color:var(--qa-color);cursor:pointer;margin-right:12px;" onclick="openAnswerModal('${q.id}')">ANSWER</span><span style="color:red;cursor:pointer;" onclick="deleteQuestion('${q.id}')">DELETE</span></div></div><div class="qa-question">${q.text}</div>`;
                if(q.answer) h+=`<div class="qa-answer-box"><b>Response:</b><br>${q.answer}</div>`;
                h+=`</div>`;
                if(q.answer) a.innerHTML+=h; else p.innerHTML+=h;
            });
        }
        function deleteQuestion(id) { if(confirm("Delete?")) { qaData=qaData.filter(q=>q.id!==id); saveQA(); } }

        function openAnswerModal(id) {
            const q = qaData.find(x => x.id === id);
            if(!q) return;
            document.getElementById('answer-id').value = id;
            document.getElementById('answer-modal-q-text').textContent = q.text;
            document.getElementById('answer-input').value = q.answer || '';
            document.getElementById('answer-modal').classList.add('open');
        }

        function closeAnswerModal() {
            document.getElementById('answer-modal').classList.remove('open');
        }

        function saveAnswer() {
            const id = document.getElementById('answer-id').value;
            const answer = document.getElementById('answer-input').value.trim();
            if(!answer) return alert("Please enter an answer");
            
            const q = qaData.find(x => x.id === id);
            if(q) {
                q.answer = answer;
                q.dateAnswered = actualTodayKey;
                saveQA();
                closeAnswerModal();
            }
        }

        // Don't auto-initialize on window.onload anymore - wait for auth
        // window.onload = initApp; // REMOVED - auth handles initialization now
    </script>
</body>
</html>
